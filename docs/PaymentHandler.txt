package handler;

import config.Environment;
import dto.PaymentRequest;
import io.vertx.ext.web.RoutingContext;
import org.json.JSONObject;

import java.util.logging.Logger;

public class PaymentHandler implements io.vertx.core.Handler<RoutingContext> {
    private static final Logger logger = Logger.getLogger(PaymentHandler.class.getName());

    @Override
    public void handle(RoutingContext ctx) {
        Environment.processLogging(
                logger,
                "Received payment processing request"
        );
        ctx.request().body().onComplete(ar -> {
            if (ar.succeeded()) {
                try {
                    var json = new JSONObject(ar.result().toString());
                    var request = new PaymentRequest(
                            json.getString("correlationId"),
                            json.getLong("amount")
                    );
                    boolean success = service.producer.PaymentServiceImpl.processPayment(request);
                    ctx.response().setStatusCode(success ? 200 : 502)
                            .end(success ? "Payment processed successfully" : "Payment processing failed");
                } catch (Exception e) {
                    ctx.response().setStatusCode(400).end("Invalid request body");
                    Environment.processLogging(
                            logger,
                            "Failed to process payment request: " + e.getMessage()
                    );
                }

            } else {
                ctx.response().setStatusCode(400).end("Invalid request body");
                Environment.processLogging(
                        logger,
                        "Failed to process payment request: " + ar.cause().getMessage()
                );
            }
        });
    }
}
